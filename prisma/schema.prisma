// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. User Roles
enum Role {
  ADMIN     // Pastor / Staff
  LEADER    // Ministry Leader
  MEMBER    // Regular User
  GUEST     // Non-registered or limited
}

// 2. The User Table
model User {
  id          String   @id @default(uuid()) // Unique ID like 'a1b2-c3d4'
  email       String   @unique
  password    String   // We will encrypt this later
  firstName   String
  lastName    String
  phone       String?
  address     String?
  role        Role     @default(MEMBER)
  avatarUrl   String?  // The ? means it can be empty
  fcmToken             String?
  notificationSettings Json?   @default("{\"chat\": true, \"sermons\": true, \"announcements\": true}")
  streak      Int      @default(0)
  habitData   Json?    @default("{\"date\": \"\", \"word\": false, \"prayer\": false, \"service\": false}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tags            UserTag[]
  conversations   Participant[]
  messages        Message[]
  registrations   Registration[]
  prayerRequests  PrayerRequest[]
  prayerInteractions PrayerInteraction[]
  posts           Post[]
  comments        Comment[]
  postReactions   PostReaction[]
  postMentions    PostMention[]

  // We will add relationships here later (like messages, donations, etc.)
}

  // ... keep everything above this line ...

model Event {
  id          String   @id @default(uuid())
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  location    String
  imageUrl    String?
  
  // ADD THIS LINE:
  registrationQuestion String? // e.g. "How many guests are you bringing?"

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // ADD THIS LINE:
  registrations Registration[]
}

model Tag {
  id    String @id @default(uuid())
  name  String
  color String // e.g., "#FF0000" for UI styling
  
  // A tag has many users
  users UserTag[]
  conversation Conversation? // Backlink
}

// This is the "Link" table connecting Users and Tags
model UserTag {
  userId String
  tagId  String
  
  user   User @relation(fields: [userId], references: [id])
  tag    Tag  @relation(fields: [tagId], references: [id])

  @@id([userId, tagId]) // Prevents adding the same user to a tag twice
}

model Donation {
  id        String   @id @default(uuid())
  amount    Int      // Stored in CENTS (e.g. $10.00 = 1000)
  currency  String   @default("usd")
  status    String   // "pending", "succeeded"
  paymentId String   // The Stripe ID (pi_123...)
  userId    String?  // Optional: Guests can give without login
  
  createdAt DateTime @default(now())
}

model Media {
  id          String   @id @default(uuid())
  title       String
  type        String   // "SERMON", "LIVESTREAM", "PODCAST"
  url         String   // e.g. "https://youtube.com/watch?v=..."
  speaker     String   // e.g. "Pastor John"
  summary     String?
  publishedAt DateTime @default(now())
}

model Conversation {
  id        String   @id @default(uuid())
  name      String?  // Optional: "Youth Group Chat"
  isGroup   Boolean  @default(false)
  createdAt DateTime @default(now())
  
  tagId     String?   @unique // Link to a tag
  tag       Tag?      @relation(fields: [tagId], references: [id])
  
  messages     Message[]
  participants Participant[]
}

model Participant {
  id             String   @id @default(uuid())
  userId         String
  conversationId String
  joinedAt       DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id])
  conversation Conversation @relation(fields: [conversationId], references: [id])
}

model Message {
  id             String   @id @default(uuid())
  content        String
  senderId       String
  conversationId String
  createdAt      DateTime @default(now())

  sender       User         @relation(fields: [senderId], references: [id])
  conversation Conversation @relation(fields: [conversationId], references: [id])
}

model Announcement {
  id        String   @id @default(uuid())
  title     String
  content   String
  isPinned  Boolean  @default(false) // Only one can be true at a time
  author    String   // e.g. "Pastor John"
  createdAt DateTime @default(now())
}


model Registration {
  id        String   @id @default(uuid())
  eventId   String
  userId    String
  answer    String?  // The user's response
  createdAt DateTime @default(now())

  event     Event    @relation(fields: [eventId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([eventId, userId]) // User can only register once per event
}

model PrayerRequest {
  id          String   @id @default(uuid())
  content     String
  isAnonymous Boolean  @default(false)
  shareToWall Boolean  @default(false)
  userId      String?
  prayCount   Int      @default(0)
  createdAt   DateTime @default(now())

  user        User?    @relation(fields: [userId], references: [id])
  interactions PrayerInteraction[]
}

model PrayerInteraction {
  id        String   @id @default(uuid())
  userId    String
  prayerId  String
  createdAt DateTime @default(now())

  user      User          @relation(fields: [userId], references: [id])
  prayer    PrayerRequest @relation(fields: [prayerId], references: [id])

  @@unique([userId, prayerId]) // One prayer per user per request
}

model SystemSetting {
  key   String @id
  value Json
}

model Post {
  id        String   @id @default(uuid())
  content   String?
  imageUrl  String?
  videoUrl  String?
  location  String?
  userId    String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  comments  Comment[]
  reactions PostReaction[]
  mentions  PostMention[]
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model PostReaction {
  id     String @id @default(uuid())
  type   String // 'PRAY', 'HEART', 'BIBLE', 'SUN'
  postId String
  userId String

  post   Post   @relation(fields: [postId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@unique([userId, postId])
}

model PostMention {
  id     String @id @default(uuid())
  postId String
  userId String

  post   Post @relation(fields: [postId], references: [id])
  user   User @relation(fields: [userId], references: [id])
}

model BibleHighlight {
  id        String   @id @default(uuid())
  book      String
  chapter   Int
  verse     Int
  color     String?  @default("yellow")
  note      String?
  createdAt DateTime @default(now())
}
